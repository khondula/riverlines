---
title: "centerlines"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Find river centerline from a surface reflectance file

```{r}
library(terra)
# library(hdf5r)
library(dplyr)
library(sf)
library(glue)
library(stringr)
library(stars)
library(scico)
library(ggplot2)
# library(smoothr)
library(gdistance)
# library(leaflet)
# library(whitebox)

```

# after points identified

```{r}
data_dir <- '/Volumes/AOPScratch/users/khondula/DATA'
checked_site_yr <- '2021_NOGP_5'
my_site_dir <- glue('{data_dir}/centerlines/01_mNDWI/{checked_site_yr}')
my_group_id <- 'heart'

riv_cent_sf <- st_read(glue('{data_dir}/centerlines/09_centerpts/{basename(my_site_dir)}/{basename(my_site_dir)}_mask01pts.shp'))

seg_df <- readxl::read_excel(glue('11_segments/segments-{basename(my_site_dir)}.xlsx'))
my_pt_ids <- unique(c(seg_df[['pt_start']], seg_df[['pt_end']]))

padn <- nchar(nrow(riv_cent_sf))
seg_pts <- riv_cent_sf %>% 
  dplyr::filter(pt_id %in% my_pt_ids) %>%
  dplyr::mutate(seg_pt_id = glue('{basename(my_site_dir)}-pt_{stringr::str_pad(pt_id, width = padn, side = "left", pad = "0")}'))

pts_dir <- glue('{data_dir}/centerlines/09_centerpts/{basename(my_site_dir)}')
seg_pts %>% st_write(glue('{pts_dir}/{basename(my_site_dir)}_seg-pts.shp'), append = FALSE)
```


# AFTER points identified 

* record point IDs for line segments in separate spreadsheet
* then read in table and filter to rows for reflectance file ID
* for each segment, create shortest path line between points

```{r}
my_dir8 <- glue('{data_dir}/centerlines/08_sobelmask20/{basename(my_site_dir)}')
sobel20_filename <- glue('{my_dir8}/sobelmask20-{my_group_id}.tif')
riv_sobel_mask20 <- terra::rast(sobel20_filename)

riv_sobel_mask20r <- gdistance::raster(riv_sobel_mask20)
tr <- gdistance::transition(riv_sobel_mask20r, function(x) 1/mean(x), directions = 8)
```


```{r}
riv_segs_df <- seg_df %>% dplyr::filter(spath)
my_seg <- riv_segs_df$segment[1]
my_seg <- 'UX'
```

```{r}
# fucntion to make path
save_spath <- function(my_seg){
  riv_seg_df <- riv_segs_df %>% dplyr::filter(segment %in% my_seg)
  pt1 <- seg_pts %>% dplyr::filter(pt_id == riv_seg_df[['pt_start']])
  pt2 <- seg_pts %>% dplyr::filter(pt_id == riv_seg_df[['pt_end']])
  # least cost path from points - For each line segment
  # my_spath <- gdistance::shortestPath(tr, origin = st_coordinates(pt1), goal = st_coordinates(pt2))
  my_spath_sp <- tryCatch(gdistance::shortestPath(tr, origin = st_coordinates(pt1), goal = st_coordinates(pt2), output = 'SpatialLines'), warning = function(w) w)
  line_sf <- my_spath_sp %>% st_as_sf()
  
  sf::st_drop_geometry(line_sf) %>% ncol()
  lines_dir <- glue('{data_dir}/centerlines/10_centerlines/{basename(my_site_dir)}')
  fs::dir_create(lines_dir)
  line_sf %>% st_write(glue('{lines_dir}/{basename(my_site_dir)}_seg{my_seg}.shp'), append = FALSE)
  message(glue('segment {my_seg} saved'))
}
try_save_spath <- purrr::possibly(save_spath, otherwise = NULL)
```

```{r}
riv_segs_df$segment %>% purrr::walk(~save_spath(.x))
```

```{r}
lines_dir <- glue('{data_dir}/centerlines/10_centerlines/{basename(my_site_dir)}')
lines_sf <- fs::dir_ls(lines_dir, glob = glue('*.shp')) %>% purrr::map(~st_read(.x)) %>% bind_rows()

lines_sf %>% 
  dplyr::mutate(seg_id = riv_segs_df$segment) %>% 
  ggplot() +
  # geom_sf(data = riv_smooth, fill = NA, col = 'blue', alpha = 0.5) +
  geom_sf(aes(col = seg_id))

# ggsave('test5.pdf')
```


```{r}
plot(my_spath_sp)
plot(raster(my_spath)) # mask mndwi with this raster? 

my_spath_rast <- terra::rast(raster(my_spath))
my_spath_mndwi <- terra::mask(m, my_spath_rast, inverse = FALSE, updatevalue = NA)

 ggplot() +
    geom_stars(data = st_as_stars(my_spath_mndwi)) +
    # colorspace::scale_fill_continuous_diverging(palette = 'Tropic', mid = 0, rev = TRUE) +
     geom_sf(data = riv_smooth, fill = NA, col = 'blue') +
    geom_sf(data = pt1) +
    geom_sf(data = pt2) +
    # geom_sf(data = line_sf, col = 'red') +
    theme_void() +
   theme(legend.position = 'bottom')
 
# ggsave('test.pdf', width = 20, height = 20)
 
ggplot() +
  geom_sf(data = riv_smooth, fill = NA, col = 'blue', lwd = 0.1) +
  geom_sf(data = pt1) +
  geom_sf(data = pt2) +
  geom_sf(data = line_sf, col = 'red') +
  theme_void() 

```

```{r}
aa <- ggplot() +
    geom_stars(data = st_as_stars(my_mndwi)) +
       colorspace::scale_fill_continuous_diverging(palette = 'Cork', mid = 0, rev = TRUE) +
    # scico::scale_fill_scico(palette = 'grayC', direction = 1) +
     geom_sf(data = riv_smooth, fill = NA, col = 'black') +
    geom_sf(data = pt1a) +
    geom_sf(data = pt1b) +
    geom_sf(data = line_sf, col = 'red') +
    theme_void() +
   theme(legend.position = 'bottom') +
   ggtitle('')

bb <- ggplot() +
    geom_stars(data = st_as_stars(my_mndwi)) +
       colorspace::scale_fill_continuous_diverging(palette = 'Cork', mid = 0, rev = TRUE) +
    # scico::scale_fill_scico(palette = 'grayC', direction = 1) +
     geom_sf(data = riv_smooth, fill = NA, col = NA) +
    # geom_sf(data = pt1a) +
    # geom_sf(data = pt1b) +
    # geom_sf(data = line_sf, col = 'red') +
    theme_void() +
   theme(legend.position = 'bottom') +
  ggtitle(glue('{my_reflectance_id} {my_aop_yr}'))

cc <- ggplot() +
    geom_stars(data = st_as_stars(my_mndwi)) +
       colorspace::scale_fill_continuous_diverging(palette = 'Cork', mid = 0, rev = TRUE) +
    # scico::scale_fill_scico(palette = 'grayC', direction = 1) +
     geom_sf(data = riv_smooth, fill = NA, col = 'black') +
    # geom_sf(data = pt1a) +
    # geom_sf(data = pt1b) +
    # geom_sf(data = line_sf, col = 'red') +
    theme_void() +
   theme(legend.position = 'bottom') +
   ggtitle('')

cp <- cowplot::plot_grid(bb, cc, aa, nrow = 1)

ggsave(glue('figs/{my_reflectance_id}-{my_aop_yr}-centerline1.png'), aa, width = 12)
```

```{r}
my_bbox <- st_bbox(my_mndwi)
aa <- ggplot() +
    geom_stars(data = st_as_stars(my_mndwi)) +
  scale_fill_viridis_c() +
    theme_void() +
    coord_sf(xlim = c(my_bbox[1], my_bbox[3]), ylim = c(my_bbox[2], my_bbox[4])) +
   theme(legend.position = 'none')
bb <- ggplot() +
    # geom_sf(data = riv_smooth, fill = NA, col = 'blue') +
    geom_sf(data = pt1a) +
    geom_sf(data = pt1b) +
    geom_sf(data = line_sf, col = 'red') +
    theme_void() +
    coord_sf(xlim = c(my_bbox[1], my_bbox[3]), ylim = c(my_bbox[2], my_bbox[4])) +
   theme(legend.position = 'bottom')

cowplot::plot_grid(aa, bb)


```

compare polygons from multiple years for same image?

```{r}
water_sf <- fs::dir_ls('polygons', glob = glue('*BONA*.shp'), recurse = TRUE) %>% purrr::map(~st_read(.x)) %>% bind_rows()

ggplot() +
  geom_sf(data = water_sf, aes(col = factor(aop_yr), fill = factor(aop_yr)), alpha = 0.1) 
```

connect lines from multiple images?

```{r}
lines_sf <- fs::dir_ls(lines_dir, regexp = '*.shp') %>% purrr::map(~st_read(.x)) %>% bind_rows()

ggplot() +
  geom_sf(data = lines_sf, aes(col = refl_id)) +
  theme(legend.position = 'none')

lines_sf %>% st_union() %>% ggplot() + geom_sf()
  # dplyr::group_by(aop_site) %>% 
  # summarise() %>% 
  # sf::st_cast("LINESTRING")
```

